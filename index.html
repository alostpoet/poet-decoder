<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Poet decoder</title>
</head>
<body>
<input type="file">
<h1 id="result">Read your Poet...</h1>
<h2 id="prime">Prime rarity will show here.</h2>

<a href="https://twitter.com/11111111111112x" class="twitter-follow-button" data-show-count="false">Follow @11111111111112x</a><script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>

<p>Do note that rarity rank is not confirmed and speculative at best. It's something the community came up with, I only made the process easier.</p>

<script>
    let input = document.querySelector('input[type=file]');

    function readFile(event) {
        let result = atob(event.target.result.match(/SS[a-zA-Z0-9=]+/g).pop());
        document.getElementById('result').innerText = result;

        let value = parseInt(result.split(' ').pop());
        let primes = [];
        primes = findPrimes(value);
        document.getElementById('prime').innerText = 'Rarity rank #' + primes.length;
    }

    function getPrimes(max) {
        var sieve = [], i, j, primes = [];
        for (i = 2; i <= max; ++i) {
            if (!sieve[i]) {
                // i has not been marked -- it is prime
                primes.push(i);
                for (j = i << 1; j <= max; j += i) {
                    sieve[j] = true;
                }
            }
        }
        return primes;
    }

    function findPrimes(n){
        function primeSieve(g,o,r){
            var t = (Math.sqrt(4+8*(g+o))-2)/4,
                e = 0,
                s = 0;

            ar.fill(true);
            if (o) {
                for(var i = Math.ceil((o-1)/3); i < (g+o-1)/3; i++) ar[1+3*i-o] = false;
                for(var i = 2; i < t; i++){
                    s = Math.ceil((o-i)/(1+2*i));
                    e = (g+o-i)/(1+2*i);
                    if (i%3-1) for(var j = s; j < e; j++) ar[i + j + 2*i*j-o] = false;
                }
            } else {
                for(var i = 1; i < (g-1)/3; i++) ar[1+3*i] = false;
                for(var i = 2; i < t; i++){
                    e = (g-i)/(1+2*i);
                    if (i%3-1) for(var j = i; j < e; j++) ar[i + j + 2*i*j] = false;
                }
            }
            for(var i = 0; i < g; i++) ar[i] && r.push((i+o)*2+1);
            return r;
        }

        var cs = n <= 1e6 ? 7500
                : n <= 1e7 ? 60000
                    : 100000, // chunk size
            cc = ~~(n/cs),                     // chunk count
            xs = n % cs,                       // excess after last chunk
            ar = Array(cs/2),                  // array used as map
            result = [];

        for(var i = 0; i < cc; i++) result = primeSieve(cs/2,i*cs/2,result);
        result = xs ? primeSieve(xs/2,cc*cs/2,result) : result;
        result[0] *=2;
        return result;
    }

    function changeFile() {
        var file = input.files[0];
        var reader = new FileReader();
        reader.addEventListener('load', readFile);
        reader.readAsBinaryString(file);
    }

    input.addEventListener('change', changeFile);

</script>
</body>
</html>
